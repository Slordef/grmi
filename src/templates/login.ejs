<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/head'); %>
</head>
<body>
    <main id="login">
        <form method="post" action="/login" enctype="application/x-www-form-urlencoded">
            <h1>GRMI</h1>
            <div class="form-group">
                <div class="label"><label for="username">Username</label></div>
                <div class="input"><input id="username" name="username" required type="text"></div>
            </div>
            <div class="form-group">
                <div class="label"><label for="password">Password</label></div>
                <div class="input"><input id="password" name="password" required type="password"></div>
            </div>
            <div class="form-group">
                <div class="label"></div>
                <div class="input"><button type="submit">Login</button></div>
            </div>
        </form>
    </main>
    <script type="application/javascript">
      function notify() {
        const notification = document.createElement('div');
        notification.classList.add('notification');
        notification.innerHTML = 'Invalid username or password';
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
      function submit(e) {
        e.preventDefault();

        const notifs = document.querySelectorAll('.notification');
        notifs.forEach(notif => notif.remove());

        const form = e.target;
        const data = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send(new URLSearchParams(data).toString());
        xhr.onload = function() {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            // set token in cookie valid for 1 hour
            document.cookie = `token=${response.token}; max-age=3600; path=/`;
            window.location.href = '/';
          } else {
            notify();
          }
        }
      }
      (function(){
            const form = document.querySelector('form');
            form.onsubmit = submit;
      })();
    </script>
</body>
</html>